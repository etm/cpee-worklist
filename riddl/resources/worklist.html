<!DOCTYPE html>
<meta charset="UTF-8"> 
<html>
<head>
<title>WT Worklist</title>
<link rel="stylesheet" href="/resources/smart-green.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
var user = "";
var json = "";

$.fn.serializeObject = function()
{
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
};

/*function ajaxCall() {
  $.ajax(
  { 
    url:"callbacks?user="+user,
    dataType:"json",
    success: function(result)
    {
      updateTable(result);
    }
  });
};*/

function longpoll(){
  console.log("Starting poll...");
  $.ajax({
    url: "callbackspoll?user="+user,
    dataType: "json",
    success: function(result) {
      updateTable(result);
    },
    complete: function() {
      console.log("...completed");
      longpoll();
    }
  });
};


function updateTable(list){
  json = list;

  $("#worklist").empty();
  for(i=0; i<list.length; ++i){i
    if(typeof list[i].worker === 'undefined' || list[i].worker == "" || list[i].worker == user)
      $("#worklist").append(
        "<tr><td><span>Inst. "+list[i].id+"</span></td>"+
        "<td><span>" +
        (list[i].form == "form-a.html" ? "Kunde anlegen" : "Zahlung genehmigen") +
        "</span></td>" +
        "<td><button name='but' id='" + 
        list[i].id +
        "' onClick='buttonClick(" + 
        list[i].id +
        ")'> Task annehmen</button>" +
        "</td></tr>"
      );
  }
}

function ajaxDelete(id){
  $.ajax({
    url: "callbacks/"+id,
    type: "DELETE"
  });
};

function showWorklist(){
  $("#reloadbutton").show();
  $("#div-login").hide();
  $("#div-form").hide();
  $("#div-worklist").show();
};

function buttonClick(id){
  url = "";
  form = "";
  
  for(i = 0; i<json.length; ++i) {
    if(json[i].id == id) {
      url = json[i].url;
      form = json[i].form;
      text = json[i].text;
      schaden = json[i].schaden;
    }
  }
 
  $("#cpeeurl").val(url);
  $("#cpeeid").val(id);
  
  $.ajax({
    url: form,
    type: "GET",
    success: function(result) {
      $("#div-worklist").hide();
      $("#div-form").show();
      $("#submitform").empty();
      if(form == "form-a.html") {
        $("#formtitle").text("Kunde anlegen");
      } else {
        $("#formtitle").text("Schaden bezahlen?");
        $("#submitform").append("Die Schadenssumme betraegt <b>"+schaden+"</b> Euro.<br/>");
        if(typeof text === 'undefined' || text == 'null' || !text) {
          $("#submitform").append("Keine Eintraege in der Kundenhistorie gefunden<br/>");
        } else {
          $("#submitform").append("In der Kundenhistorie findet sich folgender Eintrag: <br/>"+text+"<br/>");
        }
      }
      $("#submitform").append(result);
      assignUser(id);
    },
    error: function(){
      alert("Could not load UI: "+form);
    }
  });
};

function assignUser(id) {
  $.ajax({
    url: "working?user="+user+"&id="+id,
    type: "GET"
  });
}

function unassignUser() {
  id = $("#cpeeid").val();
  $.ajax({
    url: "unworking?id="+id,
    type: "GET"
  });
  showWorklist();
}

$(document).ready(function(){
  
  $("#div-login").show();
  $("#reloadbutton").hide();
  $("#div-form").hide();
  $("#div-worklist").hide();
   
  $("#login").click(function()
  {
    user = $("#username").val();
    $.ajax(
    { 
      url:"callbacks?user="+user,
      dataType:"json",
      success: function(result)
      {
        $("#reloadbutton").html("Logout "+user);
        showWorklist();
        updateTable(result);
        longpoll();
      },
      error: function() {
        alert("Benutzername/Passwort falsch");
      }
    });
  });
 
 // $("button[name=but]").on("click", function()
  
  $("#submitform").submit(function(e){
    e.preventDefault();
    var url = $("#cpeeurl").val();
    var id = $("#cpeeid").val();
    var data = JSON.stringify( $("#submitform").serializeObject() ); 
    
    $.ajax({
      url: url,
      type: "PUT",
      dataType:"json",
      contentType: "application/json",
      data: data,
      crossDomain: true, 
      complete: function(result)
      {
        ajaxDelete(id);
        showWorklist();
      }
    });
  });

  $("#unassign").click(function(){
    unassignUser();
  });

});
  
</script>
<style>
table{
  width:100%;
}
tr, td{ 
  text-align:center;
}
#unassign, #reloadbutton{
 background-color:#C45F5F;
}
#unassign:hover, #reloadbutton:hover{
 background-color:#A33939;
}
</style>
</head>

<body>
<div id="div-login">
  <h1>User w&auml;hlen</h1>
  <table><tr><td>
  <select id="username">
    <option value="admin">admin</option>
    <option value="worker">worker</option>
    <option value="clerk">clerk</option>
    <option value="batman">batman</option>
    <option value="superman">superman</option>
  </select>
  </td></tr><tr><td><br/>
  <button id="login"> Login </button>
  </td></tr></table>
</div>

<div id="div-worklist">
  <h1>Worklist:</h1>
  <table id="worklist">
  </table>
</div>

<div id="div-form">
  <h1 id="formtitle"><span id="textinfo"></span></h1>
  <form id="submitform">
    <input type=hidden />
  </form>
  <div style="width:100%; text-align:right;"><button id="unassign">Task zuruecklegen</button></div>
  <form id="hiddenform">
    <input type=hidden id="cpeeurl" />
    <input type=hidden id="cpeeid" />
  </form>
</div>
  
<button style="position:absolute; bottom: 1em; right: 1em; width:8em;" id="reloadbutton" onClick="location.reload()">Logout</button>

</body>
</html>
